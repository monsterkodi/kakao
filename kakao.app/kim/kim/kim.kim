# â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆ     â–ˆâ–ˆ
# â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ
# â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
# â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ â–ˆ â–ˆâ–ˆâ–ˆ
# â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ

use std â–ª os osproc parseopt random streams asyncdispatch posix
use rndr

params    â—‡ seq[string]
files     â—‡ seq[string]
optParser = initOptParser()
outdir    = ""
tests     = false
verbose   = false
greetings = [
    "ðŸ’‹ Keep It Simple, Stupid!",
    "ðŸ’‹ Overthink less, grin more!",
    "ðŸ’‹ Less clutter, more wonder!",
    "ðŸ’‹ The best code is no code.",
    "ðŸ’‹ Less is always beautifuller!",
    "ðŸ’‹ Simplicity: the shortcut to â€˜heck yes!â€™",
    "ðŸ’‹ If itâ€™s hard to explain, itâ€™s probably wrong.",
    "ðŸ’‹ Uncomplicate your code and your mind will dance.",
    "ðŸŒž A childâ€™s laugh, a sunbeamâ€™s path â€” why bend what is straight?",
    "ðŸŒˆ Go with the flow, catch joy like dandelion fluff.",
    "ðŸŒˆ Aim for maximum joy, anticipate future regrets.",
    "ðŸŒž Rise and shine! What shall we craft today?",
    "ðŸ‘‹ Salutations! Let's crunch some code cookies.",
    "ðŸš€ Systems nominal! Your code awaits transformation.",
    "ðŸ³ Howdy, chef! What are we cooking today?",
    "ðŸ¤– Greetings, fleshbag! May your code ripple smoothly through the machine.",
    "ðŸ”® Embrace uncertainty â€” code with glitter!",
    "ðŸŽ© Magician at the keyboard! Let's conjure some magic.",
    "ðŸŽ© Flexible beats flawless â€” everytime.",
    "ðŸŽ© Stay open, stay awesome."]  
    
farewells = [
    "ðŸ‘‹ Good bye! May your code always compile.",
    "ðŸ‘‹ Good bye! May your brackets always align.",
    "ðŸ‘‹ Farewell! May your brackets nest flawlessly.",
    "ðŸ‘‹ Farewell! May your brackets always balance."]

kimTests = walkDir(getAppFilename().splitFile()[0] / ".." / "nim" / "test").toSeq().map(â—‡tuple r âžœstring -> r.path)
kimFiles = slash.files slash.path(slash.dir(currentSourcePath()) "../kim")
kxkFiles = slash.files slash.path(slash.dir(currentSourcePath()) "../kim/kxk")
kxkTests = slash.files slash.path(slash.dir(currentSourcePath()) "kxk/test")

if verbose or true
    dbg kimTests
    dbg kimFiles
    dbg kxkFiles
    dbg kxkTests
    
randomize()

verb = â—‡string msg -> if verbose âžœ log msg 

#  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
# â–ˆâ–ˆâ–ˆ        â–ˆâ–ˆâ–ˆ          â–ˆâ–ˆâ–ˆ           â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆ   
# â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ      â–ˆâ–ˆâ–ˆ           â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ      â–ˆâ–ˆâ–ˆ   
# â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ          â–ˆâ–ˆâ–ˆ           â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ           â–ˆâ–ˆâ–ˆ   
#  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆ            â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ           â–ˆâ–ˆâ–ˆ   

for kind key val in optParser.getopt()
    switch kind
        cmdArgument
            params.add key
            files.add(key)
        cmdLongOption cmdShortOption
            params.add '-' & key
            switch key
                "test" "t"
                    tests = true
                "verbose" "v"
                    verbose = true
                "outdir" "o"
                    outdir = val
                "help" "h"
                    log "usage: " getAppFilename().extractFilename() " [options] [file.kim ...]"
                    log ""
                    log "      transpiles kim files to nim"
                    log "      watches cwd if no files are given"
                    log ""
                    log "options:"
                    log "  -o --outdir:DIR  output directory"
                    log "     --test        run tests"
                    log "  -v --verbose     verbose output"
                    quit 1
                âžœ 
                    log "unknown option!: " key
                    quit 1
        cmdEnd
            discard
                        
# â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
# â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ       â–ˆâ–ˆâ–ˆ          â–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆ   
# â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ      â–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ       â–ˆâ–ˆâ–ˆ   
# â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ            â–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆ   
# â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ      â–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆ   
            
when defined(posix)

    use posix
    
    restart = ->
        args = allocCStringArray @[getAppFilename()] & params
        discard execv getAppFilename().cstring() args
        quit 1 # only reaches here if execve fails
    
# â–ˆâ–ˆâ–ˆ       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
# â–ˆâ–ˆâ–ˆ      â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ        â–ˆâ–ˆâ–ˆ       â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ      â–ˆâ–ˆâ–ˆ     
# â–ˆâ–ˆâ–ˆ      â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 
# â–ˆâ–ˆâ–ˆ      â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ       â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ      â–ˆâ–ˆâ–ˆ     
# â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ       â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ

logFile = â—‡string f prefix="" ->

    (dir name ext) = f.relativePath(getCurrentDir()).splitFile()
    d = if dir.len âžœ dir & "/" âžœ ""
    icon  = if ext == ".kim" âžœ "î·«  " âžœ "î¡  "
    color = if ext == ".kim" âžœ fgGreen âžœ fgMagenta

    styledEcho color prefix styleDim icon resetStyle
               color styleBright d styleBright name resetStyle
        
#  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆ     â–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
# â–ˆâ–ˆâ–ˆ       â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ      â–ˆâ–ˆâ–ˆ     
# â–ˆâ–ˆâ–ˆ       â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 
# â–ˆâ–ˆâ–ˆ       â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ â–ˆ â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ        â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ      â–ˆâ–ˆâ–ˆ     
#  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ        â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ

compile = â—‡string file outDir="bin" âžœbool ->

    # nim c --outDir:bin --colors:on --stackTrace:on --lineTrace:on --warning:User:off nim/kim.nim

    profileScope 'comp'
    cmd = "nim c -d:danger --outDir=#{outdir} --stackTrace:on --lineTrace:on --colors:on --warning:User:off #{file}"
    # cmd = "nim c -d:danger -d:nimNoLentIterators --outDir=#{outdir} --stackTrace:on --lineTrace:on --colors:on --warning:User:off #{file}"
    # cmd = "nim c --outDir=#{outdir} --mm:arc --colors:on --stackTrace:on --lineTrace:on --warning:User:off #{file}"
    (output exitCode) = execCmdEx(cmd)
        
    if exitCode != 0
        styledEcho fgRed "âœ˜ " $cmd
        log output
        false
    else
        if verbose
            styledEcho fgGreen "âœ” " fgWhite cmd
        true
        
# â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
#    â–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆ       â–ˆâ–ˆâ–ˆ          â–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆ     
#    â–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ      â–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 
#    â–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆ            â–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆ          â–ˆâ–ˆâ–ˆ
#    â–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ      â–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 

runTests = â—‡seq[string] files âžœbool ->

    profileScope 'test'
    anyFail = false
    
    for f in files
        args = ["r" "--colors:on" "--stackTrace:on" "--lineTrace:on" "--warning:User:off" f]  
        # args = ["r" "-d:nimNoLentIterators" "--colors:on" "--stackTrace:on" "--lineTrace:on" "--warning:User:off" f]  
        process = startProcess command="nim" args=args options={poInteractive poUsePath}
        defer: process.close()
        startTime = getMonoTime()
        output = ""
        outhnd = process.outputHandle
        flags = fcntl outhnd F_GETFL 0
        discard fcntl outhnd F_SETFL flags or O_NONBLOCK
        
        thisFail = false
        
        while true
            elapsed = (getMonoTime() - startTime).inMilliseconds
            if elapsed >= 5000
                anyFail = true
                thisFail = true
                output.add "test killed after #{elapsed} ms!!"
                process.terminate()
                sleep 50
                if process.running
                    process.kill()
                break
                            
            line = newString 1024*10
            bytesRead = read outhnd addr(line[0]) line.len
            if 
                bytesRead > 0   âžœ output.add line & "\n"
                bytesRead == 0  âžœ break
                errno == EAGAIN âžœ discard poll nil 0 50
                                âžœ break
                
        exitCode = process.waitForExit()
        if exitCode != 0 or verbose or thisFail or slash.contains(f "tok.nim")
            styledEcho output.replace("[Suite]"  fg(fgYellow) & "â–¸\x1b[0m")
                             .replace("[OK]"     fg(fgGreen) & "âœ”\x1b[0m")
                             .replace("[FAILED]" fg(fgRed) & "âœ˜\x1b[0m")                             
        else
            okCount = output.count "[OK]"
            styledEcho output.replace("[Suite]"  fg(fgYellow) & "â–¸\x1b[0m")
                             .replace(peg"'[OK]' .+" "#{ansiStyleCode(styleDim)} âœ” #{okCount}\x1b[0m")
            
        for line in process.errorStream.lines
            log line
        
        if exitCode != 0
            # echo output
            styledEcho fgRed "âœ˜ " $f
            anyFail = true
            
    # log ""
    not anyFail

if files.len

    # profileStart 'translate'
    transpiled = rndr.files files
    # profileStop 'translate'
    quit transpiled.len - files.len

if tests

    exit = if runTests(kimTests) âžœ 0 âžœ 1
    quit exit
    
#  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
# â–ˆâ–ˆâ–ˆ          â–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ        â–ˆâ–ˆâ–ˆ     
# â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ      â–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 
#      â–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ     
# â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ      â–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ

stage = â—‡seq[string] kimFiles â—‡string src â—‡string dst âžœbool ->

    profileStart dst & " "
    for f in kimFiles 
        slash.copy f f.replace("/kim/kim/" "/kim/#{dst}/kim/")
    
    for f in kimFiles 
        # logFile f "âžœ "
        (output exitCode) = execCmdEx "#{src}/bin/kim -v " & f.replace("/kim/kim/" "/kim/#{dst}/kim/")
        if exitCode != 0
            log output
            logFile f "âœ˜ "
            â®  false
    profileStop dst & " "
        
    if compile "#{dst}/nim/kim.nim" "#{dst}/bin"
        profileStart "test"
        (output exitCode) = execCmdEx "#{dst}/bin/kim --test"
        profileStop "test"
        if exitCode == 0
            â®  true
        else
            log output
    log "âœ˜ #{dst}"
    false
 
# â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ
# â–ˆâ–ˆâ–ˆ â–ˆ â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆ       â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ
# â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆ       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
# â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆ       â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ
# â–ˆâ–ˆ     â–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆ      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ

watch = â—‡seq[string] paths ->

    hook = -> {.noconv.}
        styledEcho ""
        styledEcho fgGreen farewells[rand(farewells.high)]
        quit 0
        
    setControlCHook hook
    
    modTimes â—‡ Table[string, times.Time]
    
    styledEcho ""
    styledEcho fgGreen greetings[rand(greetings.high)]
    styledEcho ""
    
    for p in paths
        (dir name ext) = p.splitFile()
        styledEcho fgBlue styleDim "â— " resetStyle
            styleBright fgBlue dir " " resetStyle 
            styleBright fgYellow name styleDim ext resetStyle
    
    while true
    
        # GC_fullCollect()
        # log GC_getStatistics()
        
        kimToTranspile â—‡ seq[string]
        kxkToTranspile â—‡ seq[string]
        
        kxkChanged = false
        kimChanged = false
        
        for path in paths
        
            continue if not dirExists path
                
            for f in walkDirRec path

                continue if slash.ext(f) != "kim"
                
                modTime = getFileInfo(f).lastWriteTime
                
                if not modTimes.hasKey(f)
                    modTimes[f] = modTime
                    continue
                  
                if modTimes[f] == modTime
                    continue
        
                modTimes[f] = modTime
                
                if   f in kxkFiles âžœ kxkChanged = true ; kxkToTranspile.add(f)
                elif f in kimFiles âžœ kimChanged = true ; kimToTranspile.add(f)
        
        if kxkChanged or kimChanged
            log "\x1bc"
            for f in kxkToTranspile.concat(kimToTranspile)
                logFile f "â–¸ "
                    
        if kxkChanged
            fail = false
            for f in kxkToTranspile
                # logFile f "âžœ "
                (output exitCode) = execCmdEx "bin/kim -v " & f
                if exitCode != 0
                    log output
                    fail = true                
            if not fail
                if runTests kxkTests
                    log "âœ”"
                
        if kimChanged
                
            if stage kimFiles "." "k1m"
                if stage kimFiles "k1m" "k2m"
                    for f in kimFiles 
                        srcNim = f.replace("/kim/kim/" "/kim/k2m/nim/").replace(".kim" ".nim")
                        tgtNim = f.replace("/kim/kim/" "/kim/nim/").replace(".kim" ".nim")
                        # log "src " srcNim
                        # log "tgt " tgtNim
                        slash.copy srcNim tgtNim
                    if compile "k2m/nim/kim.nim" "bin"
                        log "-> enjoy"
                        restart()
        sleep 200
        
watch [cwd("kim")]
                 