# ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà  ‚ñà‚ñà     ‚ñà‚ñà
# ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà
# ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
# ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà ‚ñà ‚ñà‚ñà‚ñà
# ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà

use std ‚ñ™ os osproc parseopt random streams asyncdispatch asyncfile posix
use rndr

params    ‚óá seq[string]
files     ‚óá seq[string]
optParser = initOptParser()
outdir    = ""
tests     = false
verbose   = false
greetings = [
    "üíã Keep It Simple, Stupid!",
    "üíã Overthink less, grin more!",
    "üíã Less clutter, more wonder!",
    "üíã The best code is no code.",
    "üíã Less is always beautifuller!",
    "üíã Simplicity: the shortcut to ‚Äòheck yes!‚Äô",
    "üíã If it‚Äôs hard to explain, it‚Äôs probably wrong.",
    "üíã Uncomplicate your code and your mind will dance.",
    "üåû A child‚Äôs laugh, a sunbeam‚Äôs path ‚Äî why bend what is straight?",
    "üåà Go with the flow, catch joy like dandelion fluff.",
    "üåà Aim for maximum joy, anticipate future regrets.",
    "üåû Rise and shine! What shall we craft today?",
    "üëã Salutations! Let's crunch some code cookies.",
    "üöÄ Systems nominal! Your code awaits transformation.",
    "üç≥ Howdy, chef! What are we cooking today?",
    "ü§ñ Greetings, fleshbag! May your code ripple smoothly through the machine.",
    "üîÆ Embrace uncertainty ‚Äî code with glitter!",
    "üé© Magician at the keyboard! Let's conjure some magic.",
    "üé© Flexible beats flawless ‚Äî everytime.",
    "üé© Stay open, stay awesome."]  
    
farewells = [
    "üëã Good bye! May your code always compile.",
    "üëã Good bye! May your brackets always align.",
    "üëã Farewell! May your brackets nest flawlessly.",
    "üëã Farewell! May your brackets always balance."]

testFiles = walkDir(getAppFilename().splitFile()[0] / ".." / "nim" / "test").toSeq().map(‚óátuple r ‚ûústring -> r.path)
    
randomize()

verb = ‚óástring msg -> 
    if verbose ‚ûú log msg 

#  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà         ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
# ‚ñà‚ñà‚ñà        ‚ñà‚ñà‚ñà          ‚ñà‚ñà‚ñà           ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà   
# ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà      ‚ñà‚ñà‚ñà           ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà      ‚ñà‚ñà‚ñà   
# ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà          ‚ñà‚ñà‚ñà           ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà           ‚ñà‚ñà‚ñà   
#  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà            ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà           ‚ñà‚ñà‚ñà   

for kind key val in optParser.getopt()
    switch kind
        cmdArgument
            params.add key
            files.add(key)
        cmdLongOption cmdShortOption
            params.add '-' & key
            switch key
                "test" "t"
                    tests = true
                "verbose" "v"
                    verbose = true
                "outdir" "o"
                    outdir = val
                "help" "h"
                    log "usage: " getAppFilename().extractFilename() " [options] [file.kim ...]"
                    log ""
                    log "      transpiles kim files to nim"
                    log "      watches cwd if no files are given"
                    log ""
                    log "options:"
                    log "  -o --outdir:DIR  output directory"
                    log "     --test        run tests"
                    log "  -v --verbose     verbose output"
                    quit 1
                ‚ûú 
                    log "unknown option!: " key
                    quit 1
        cmdEnd
            discard
                        
# ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
# ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà       ‚ñà‚ñà‚ñà          ‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà   
# ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà      ‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà       ‚ñà‚ñà‚ñà   
# ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà            ‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà   
# ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà      ‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà   
            
when defined(posix)

    use posix
    
    restart = ->
        args = allocCStringArray @[getAppFilename()] & params
        discard execv getAppFilename().cstring() args
        quit 1 # only reaches here if execve fails
    
# ‚ñà‚ñà‚ñà       ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà      ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
# ‚ñà‚ñà‚ñà      ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà        ‚ñà‚ñà‚ñà       ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà      ‚ñà‚ñà‚ñà     
# ‚ñà‚ñà‚ñà      ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà      ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà 
# ‚ñà‚ñà‚ñà      ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà       ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà      ‚ñà‚ñà‚ñà     
# ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà       ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà

logFile = ‚óástring f prefix="" ->

    (dir name ext) = f.relativePath(getCurrentDir()).splitFile()
    d = if dir.len ‚ûú dir & "/" ‚ûú ""
    icon  = if ext == ".kim" ‚ûú "Ó∑´  " ‚ûú "Ó°Å  "
    color = if ext == ".kim" ‚ûú fgGreen ‚ûú fgMagenta

    styledEcho color prefix styleDim icon resetStyle
               color styleBright d styleBright name resetStyle
        
#  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà     ‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà      ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
# ‚ñà‚ñà‚ñà       ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà      ‚ñà‚ñà‚ñà     
# ‚ñà‚ñà‚ñà       ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà      ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà 
# ‚ñà‚ñà‚ñà       ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà ‚ñà ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà        ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà      ‚ñà‚ñà‚ñà     
#  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà        ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà

compile = ‚óástring file outDir="bin" ‚ûúbool ->

    # nim c --outDir:bin --colors:on --stackTrace:on --lineTrace:on --warning:User:off nim/kim.nim

    profileScope 'comp'
    cmd = "nim c -d:danger --outDir=#{outdir} --mm:arc --colors:on --warning:User:off #{file}"
    # cmd = "nim c --outDir=#{outdir} --mm:arc --colors:on --stackTrace:on --lineTrace:on --warning:User:off #{file}"
    (output exitCode) = execCmdEx(cmd)
        
    if exitCode != 0
        styledEcho fgRed "‚úò " $cmd
        log output
        false
    else
        if verbose
            styledEcho fgGreen "‚úî " fgWhite cmd
        true
        
# ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
#    ‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà       ‚ñà‚ñà‚ñà          ‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà     
#    ‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà      ‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà 
#    ‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà            ‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà          ‚ñà‚ñà‚ñà
#    ‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà      ‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà 

runTests = ‚ûúbool ->

    profileScope 'test'
    anyFail = false
    
    for f in testFiles
        args = ["r" "--colors:on" "--stackTrace:on" "--lineTrace:on" "--warning:User:off" f]  
        process = startProcess command="nim" args=args options={poInteractive poUsePath}
        defer: process.close()
        startTime = getMonoTime()
        output = ""
        outhnd = process.outputHandle
        flags = fcntl outhnd F_GETFL 0
        discard fcntl outhnd F_SETFL flags or O_NONBLOCK
        
        thisFail = false
        
        while true
            elapsed = (getMonoTime() - startTime).inMilliseconds
            if elapsed >= 5000
                anyFail = true
                thisFail = true
                output.add "test killed after #{elapsed} ms!!"
                process.terminate()
                sleep 50
                if process.running
                    process.kill()
                break
                            
            line = newString 1024*10
            bytesRead = read outhnd addr(line[0]) line.len
            if 
                bytesRead > 0   ‚ûú output.add line & "\n"
                bytesRead == 0  ‚ûú break
                errno == EAGAIN ‚ûú discard poll nil 0 50
                                ‚ûú break
                
        exitCode = process.waitForExit()
        if exitCode != 0 or verbose or thisFail
            styledEcho output.replace("[Suite]"  fg(fgYellow) & "‚ñ∏\x1b[0m")
                             .replace("[OK]"     fg(fgGreen) & "‚úî\x1b[0m")
                             .replace("[FAILED]" fg(fgRed) & "‚úò\x1b[0m")                             
        else
            okCount = output.count "[OK]"
            styledEcho output.replace("[Suite]"  fg(fgYellow) & "‚ñ∏\x1b[0m")
                             .replace(peg"'[OK]' .+" "#{ansiStyleCode(styleDim)} ‚úî #{okCount}\x1b[0m")
            
        for line in process.errorStream.lines
            log line
        
        if exitCode != 0
            # echo output
            styledEcho fgRed "‚úò " $f
            anyFail = true
    # log ""
    not anyFail

if files.len

    # profileStart 'translate'
    transpiled = rndr.files files
    # profileStop 'translate'
    quit transpiled.len - files.len

if tests

    exit = if runTests() ‚ûú 0 ‚ûú 1
    quit exit
    
#  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
# ‚ñà‚ñà‚ñà          ‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà        ‚ñà‚ñà‚ñà     
# ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà      ‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà 
#      ‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà     
# ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà      ‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà

stage = ‚óáseq[string] kimFiles ‚óástring src ‚óástring dst ‚ûúbool ->

    profileStart dst & " "
    for f in kimFiles 
        copyFileWithPermissions f f.replace("/kim/kim/" "/kim/#{dst}/kim/")
    
    for f in kimFiles 
        (output exitCode) = execCmdEx "#{src}/bin/kim " & f.replace("/kim/kim/" "/kim/#{dst}/kim/")
        if exitCode != 0
            log output
            logFile f "‚úò "
            ‚Æê  false
    profileStop dst & " "
        
    if compile "#{dst}/nim/kim.nim" "#{dst}/bin"
        profileStart "test"
        (output exitCode) = execCmdEx "#{dst}/bin/kim --test"
        profileStop "test"
        if exitCode == 0
            ‚Æê  true
        else
            log output
    log "‚úò #{dst}"
    false
 
# ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà
# ‚ñà‚ñà‚ñà ‚ñà ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà       ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà
# ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà       ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
# ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà       ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà
# ‚ñà‚ñà     ‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà      ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà

watch = ‚óáseq[string] paths ->

    hook = -> {.noconv.}
        styledEcho ""
        styledEcho fgGreen farewells[rand(farewells.high)]
        quit 0
        
    setControlCHook hook
    
    modTimes ‚óá Table[string, times.Time]
    
    styledEcho ""
    styledEcho fgGreen greetings[rand(greetings.high)]
    styledEcho ""
    
    for p in paths
        (dir name ext) = p.splitFile()
        styledEcho fgBlue styleDim "‚óè " resetStyle
            styleBright fgBlue dir " " resetStyle 
            styleBright fgYellow name styleDim ext resetStyle
    
    firstLoop = true
    
    while true
    
        # GC_fullCollect()
        # log GC_getStatistics()
        
        toTranspile ‚óá seq[string]
        kimFiles    ‚óá seq[string]
        
        for path in paths
        
            if not dirExists(path)
            
                continue
                
            for f in walkDirRec(path)
            
                (dir _ ext) = f.splitFile()
                
                if ext == ".kim" ‚ûú kimFiles.add(f) ‚ûú continue
                
                modTime = getFileInfo(f).lastWriteTime
                
                if not modTimes.hasKey(f)
                    modTimes[f] = modTime
                    continue
                  
                if modTimes[f] == modTime
                    continue
        
                modTimes[f] = modTime
                
                if ext == ".kim" and dir.find("kxk") < 0
                    log dir.find("kxk")
                    toTranspile.add f
                
        if firstLoop                                    
            firstLoop = false
            if verbose
                for f in kimFiles ‚ûú logFile f
                
        if toTranspile
            log "\x1bc"
            for f in toTranspile
                logFile f "‚ñ∏ "
                
            if stage kimFiles "." "k1m"
                if stage kimFiles "k1m" "k2m"
                    log "-> deploy"
                    for f in kimFiles 
                        srcNim = f.replace("/kim/kim/" "/kim/k2m/nim/").replace(".kim" ".nim")
                        tgtNim = f.replace("/kim/kim/" "/kim/nim/").replace(".kim" ".nim")
                        copyFileWithPermissions srcNim tgtNim
                    if compile "k2m/nim/kim.nim" "bin"
                        restart()
        sleep 200
        
watch [getCurrentDir() & "/kim"]
                 