###
 0000000   0000000   00     00  00000000   000      00000000  000000000  00000000
000       000   000  000   000  000   000  000      000          000     000     
000       000   000  000000000  00000000   000      0000000      000     0000000 
000       000   000  000 0 000  000        000      000          000     000     
 0000000   0000000   000   000  000        0000000  00000000     000     00000000
###

use ../../kxk ‚ñ™ kseg kutil post
use ../theme  ‚óÜ theme 
use ./tool    ‚óÜ belt
use           ‚óÜ specs

function complete

    @: @editor ->
        
        @name = @editor.name + '_complete'
        
        @choices = new choices_class @editor.cells.screen "#{@name}_choices" ['scrllr']
        @choices.focusable = false
        @choices.rounded   = false
        
        @color = bg: theme.editor_selection
        
        @choices.setColor 'bg' theme.editor_complete_choices
        
        @choices.scroll.handle = '‚ñê'
        @choices.scroll.setColor 'bg'   theme.editor_complete_choices
        @choices.scroll.setColor 'knob' theme.editor_complete_choices_scroll
        @choices.scroll.setColor 'dot'  theme.editor_complete_choices_scroll
        
        @choices.on 'action' @onChoicesAction
        
        @visible = false

    #  0000000   0000000   00     00  00000000   000      00000000  000000000  00000000  
    # 000       000   000  000   000  000   000  000      000          000     000       
    # 000       000   000  000000000  00000000   000      0000000      000     0000000   
    # 000       000   000  000 0 000  000        000      000          000     000       
    #  0000000   0000000   000   000  000        0000000  00000000     000     00000000  
    
    complete: -> 
    
        before = @editor.state.chunkBeforeCursor()
        if tct = kseg.tailCountTurd before
            before = before[before.length-1..]
        else if tcw = kseg.tailCountWord before
            if tcw < before.length
                before = before[before.length-tcw..]
        @word before
        
    # 000   000   0000000   00000000   0000000    
    # 000 0 000  000   000  000   000  000   000  
    # 000000000  000   000  0000000    000   000  
    # 000   000  000   000  000   000  000   000  
    # 00     00   0000000   000   000  0000000    
    
    word: @turd ->
    
        if empty @turd
            @hide()
            ‚Æê 
                
        @words = kseg.chunks(@editor.state.s.lines).map (chunk) -> chunk.chunk        
        @words = belt.prepareWordsForCompletion @turd @words
        
        if inserts = specs.trigger[@turd]  # prepend special completions, eg ~O 
            @words = inserts.concat @words

        @visible = valid @words

        ‚Æê if empty @words
        
        mc = @editor.state.mainCursor()
        
        head = @words[0]
        
        cx = mc[0] - @editor.state.s.view[0]     
        cy = mc[1] - @editor.state.s.view[1]
        
        for ch,ci in head[@turd.length..]
            @editor.cells.set cx+ci cy ch '#fff' theme.selection
        
        if @words.length <= 1
            @choices.clear()                    
        else
            mlw = max 1 belt.widthOfLines(@words)
            
            h = min 8 @words.length
            x  = @editor.cells.x+cx-@turd.length
            y  = @editor.cells.y+cy+1
            
            @choices.layout x y mlw+3 h
            @choices.set @words.map((w) -> ' '+w)
            @choices.selectFirst()
        
    # 000   000  000  0000000    00000000  
    # 000   000  000  000   000  000       
    # 000000000  000  000   000  0000000   
    # 000   000  000  000   000  000       
    # 000   000  000  0000000    00000000  
    
    hide: -> 
        ‚Æê  if not @visible
        @editor.state.syntax.setSegls @editor.state.s.lines # ùúèùñçùöíùñò ùöíùñò ùïí ùîüùöíùúè ùîü…ºùìäùúèùïí‚üÖ, ùöíùñò‚à©'ùúè ùöíùúè?
        @visible = false
        
    hidden: -> not @visible
        
    onEditorLayout: =>
    
        ‚Æê  if @hidden()
        
    # ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà
    # ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà        ‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà 
    # ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà‚ñà‚ñà  
    # ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà          ‚ñà‚ñà‚ñà   
    # ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà   

    handleKey: key event ->
        
        ‚Æê 'unhandled' if @hidden() or empty @words
        
        switch key
            'tab'
            'right'
            'return' ‚ûú ‚Æê @apply()
            'esc'    ‚ûú ‚Æê @hide()
            'up'
            'down' 
                if @words.length > 1
                    ‚Æê @moveSelection key
        
        'unhandled'
    
    # 00     00   0000000   000   000   0000000  00000000  
    # 000   000  000   000  000   000  000       000       
    # 000000000  000   000  000   000  0000000   0000000   
    # 000 0 000  000   000  000   000       000  000       
    # 000   000   0000000    0000000   0000000   00000000  
    
    onMouse: event =>
        
        ‚Æê if @hidden()
        
        cret = @choices.onMouse event
        
        if not cret and event.type in ['press' 'drag' 'release']
            @hide()
            ‚Æê 
        
        cret

    onWheel: event => 
        
        ‚Æê if @hidden()
        
        @choices.onWheel event
        
    #  0000000  00000000  000      00000000   0000000  000000000  
    # 000       000       000      000       000          000     
    # 0000000   0000000   000      0000000   000          000     
    #      000  000       000      000       000          000     
    # 0000000   00000000  0000000  00000000   0000000     000     
    
    moveSelection: dir ->
        
        @choices.moveSelection dir
        
    #  0000000   00000000   00000000   000      000   000  
    # 000   000  000   000  000   000  000       000 000   
    # 000000000  00000000   00000000   000        00000    
    # 000   000  000        000        000         000     
    # 000   000  000        000        0000000     000     
    
    apply: ->
    
        word = @currentWord()
        
        if specs.inserts[word]
            @editor.state.delete 'back'
            @editor.state.insert word
        else
            @editor.state.insert word[@turd.length..]
                    
        post.emit 'focus' 'editor'
        @complete()
        
    #  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà          ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà
    # ‚ñà‚ñà‚ñà       ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà       ‚ñà‚ñà‚ñà        ‚ñà‚ñà‚ñà              ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà          ‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà
    # ‚ñà‚ñà‚ñà       ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà       ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà          ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà          ‚ñà‚ñà‚ñà          ‚ñà‚ñà‚ñà ‚ñà ‚ñà‚ñà‚ñà
    # ‚ñà‚ñà‚ñà       ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà       ‚ñà‚ñà‚ñà             ‚ñà‚ñà‚ñà         ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà          ‚ñà‚ñà‚ñà          ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà
    #  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà          ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà          ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà

    onChoicesAction: action choice=>
        
        switch action
            'click' ‚ûú ‚Æê @apply()
            
    #  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà      ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  
    # ‚ñà‚ñà‚ñà       ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà       ‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà         ‚ñà‚ñà‚ñà ‚ñà ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà
    # ‚ñà‚ñà‚ñà       ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà ‚ñà ‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà         ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà
    # ‚ñà‚ñà‚ñà       ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà       ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà         ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà
    #  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà         ‚ñà‚ñà     ‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  

    currentWord: ->
        
        word = @choices.current trim:'front'
        if empty word
            word = @words[0]
        word
        
    preDrawLines: lines ->
    
        ‚Æê  lines if @hidden() or empty @words
        ‚óè pre draw
        word  = @currentWord()
        lines = lines.asMutable()
        for pos in @editor.state.s.cursors
            kutil.replace lines[pos[1]] pos[0] 0 kseg(word[@turd.length..])
        @editor.state.syntax.setSegls kseg.segls(lines) # ùúèùñçùöíùñò ùöíùñò ùïí ùîüùöíùúè ùîü…ºùìäùúèùïí‚üÖ, ùöíùñò‚à©'ùúè ùöíùúè?
        lines
        
    # 0000000    00000000    0000000   000   000  
    # 000   000  000   000  000   000  000 0 000  
    # 000   000  0000000    000000000  000000000  
    # 000   000  000   000  000   000  000   000  
    # 0000000    000   000  000   000  00     00  
    
    draw: ->
        
        ‚Æê  if @hidden() or empty @words

        word = @currentWord()
        
        # log "complete #{word} #{@choices.current()} #{@words.length}" @words
        
        for pos in @editor.state.s.cursors # highlight the insertions
            
            cx = pos[0] - @editor.state.s.view[0]
            cy = pos[1] - @editor.state.s.view[1]
            
            for ci in 0...word.length-@turd.length
                @editor.cells.set_bg cx+ci cy @color.bg

        ‚Æê  if @words.length <= 1
        
        # draw the popup below the main cursor
        
        mc = @editor.state.mainCursor()
         
        cx = mc[0] - @editor.state.s.view[0]
        cy = mc[1] - @editor.state.s.view[1]
        
        fx = cx-@turd.length-1
        x  = fx+1+@editor.cells.x
        y  = cy+@editor.cells.y+2
        w  = @choices.cells.cols+1
        h  = @choices.cells.rows
        
        fy = cy+1

        @editor.cells.draw_frame fx fy fx+w+1 fy+h+1 fg:theme.editor_complete_choices bg:'#000'
        
        @choices.layout x y w h
        @choices.draw()

export complete
